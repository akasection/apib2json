#!/usr/bin/env node
/* eslint no-console: 0 */

/**
 * This file is part of the apib2json
 *
 * Copyright (c) 2021 Petr Bugy√≠k
 *
 * For the full copyright and license information, please view
 * the file LICENSE.md that was distributed with this source code.
 */

const Fs = require('fs');
const Commander = require('commander');
const info = require('../package.json');
const Apib2Json = require('../lib/apib2json');

const Program = new Commander.Command();

Program.configureHelp({
    sortOptions: true,
});

Program
    .description(info.description)
    .helpOption('-h, --help', 'Prints this help')
    .option('--indent <number>', 'Number of space characters used to indent code, use with --pretty', 2)
    .option('-d, --debug', 'Debug (verbose) mode, use only with --output', false)
    .option('-i, --input <file>', 'Path to input (Apib) file (default: STDIN)')
    .option('-o, --output <file>', 'Path to output (JSON) file (default: STDOUT)')
    .option('-p, --pretty', 'Output pretty (indented) JSON', false)
    .version(info.version, '-v, --version', 'Prints version');

Program.parse(process.argv);

function main(input) {
    (new Apib2Json(Program.opts()))
        .toJson(input)
        .then((json) => {
            Program.output
                ? Fs.writeFileSync(Program.output, json)
                : process.stdout.write(json);
        })
        .catch((error) => {
            console.error('ERROR: Problem with parsing of API Blueprint.', '\n');
            console.error(JSON.stringify(error, null, 2));
            process.exit(error.code);
        });
}

let input = '';
if (process.stdin.isTTY) {
    if (!Program.input) {
        Program.outputHelp();
        process.exit(1);
    }

    try {
        input = Fs
            .readFileSync(Program.input)
            .toString();
    } catch (e) {
        console.error(`File "${Program.input}" cannot be opened.`);
        process.exit(1);
    }

    main(input);
} else {
    process.stdin.on('data', (chunk) => {
        input += chunk;
    });

    process.stdin.on('end', () => {
        if (!input) {
            Program.outputHelp();
            process.exit(1);
        }

        main(input);
    });

    process.stdin.setEncoding('utf8');
}
